<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.travel.mapper.AttractionMapper">

    <resultMap id="BaseResultMap" type="com.travel.entity.Attraction">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="location" property="location"/>
        <result column="province" property="province"/>
        <result column="city" property="city"/>
        <result column="district" property="district"/>
        <result column="address" property="address"/>
        <result column="description" property="description"/>
        <result column="images" property="images" typeHandler="com.travel.mapper.typehandler.JsonListTypeHandler"/>
        <result column="video_url" property="videoUrl"/>
        <result column="open_time" property="openTime"/>
        <result column="contact_phone" property="contactPhone"/>
        <result column="longitude" property="longitude"/>
        <result column="latitude" property="latitude"/>
        <result column="ticket_price" property="ticketPrice"/>
        <result column="ticket_stock" property="ticketStock"/>
        <result column="valid_period" property="validPeriod"/>
        <result column="status" property="status"/>
        <result column="rating" property="rating"/>
        <result column="tags" property="tags" typeHandler="com.travel.mapper.typehandler.JsonListTypeHandler"/>
        <result column="admission_notice" property="admissionNotice"/>
        <result column="admission_notice_url" property="admissionNoticeUrl"/>
        <result column="golden_summit_enabled" property="goldenSummitEnabled"/>
        <result column="sync_source" property="syncSource"/>
        <result column="sync_time" property="syncTime"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>

    <sql id="Base_Column_List">
        id, name, location, province, city, district, address, description, images,
        video_url, open_time, contact_phone, longitude, latitude, ticket_price,
        ticket_stock, valid_period, status, rating, tags, admission_notice, admission_notice_url,
        golden_summit_enabled, sync_source, sync_time, create_time, update_time
    </sql>

    <!-- 根据ID查询 -->
    <select id="selectById" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM attraction
        WHERE id = #{id}
    </select>

    <!-- 分页查询景点列表 -->
    <select id="selectList" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM attraction
        <where>
            <if test="name != null and name != ''">
                AND name LIKE CONCAT('%', #{name}, '%')
            </if>
            <if test="city != null and city != ''">
                AND city = #{city}
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
        </where>
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 统计景点总数 -->
    <select id="count" resultType="long">
        SELECT COUNT(*)
        FROM attraction
        <where>
            <if test="name != null and name != ''">
                AND name LIKE CONCAT('%', #{name}, '%')
            </if>
            <if test="city != null and city != ''">
                AND city = #{city}
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
        </where>
    </select>

    <!-- 插入景点 -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO attraction (
            name, location, province, city, district, address, description, images,
            video_url, open_time, contact_phone, longitude, latitude, ticket_price,
            ticket_stock, valid_period, status, rating, tags, admission_notice, admission_notice_url,
            golden_summit_enabled, sync_source, sync_time
        ) VALUES (
            #{name}, #{location}, #{province}, #{city}, #{district}, #{address}, #{description},
            #{images, typeHandler=com.travel.mapper.typehandler.JsonListTypeHandler},
            #{videoUrl}, #{openTime}, #{contactPhone}, #{longitude}, #{latitude},
            #{ticketPrice}, #{ticketStock}, #{validPeriod}, #{status}, #{rating},
            #{tags, typeHandler=com.travel.mapper.typehandler.JsonListTypeHandler},
            #{admissionNotice}, #{admissionNoticeUrl}, #{goldenSummitEnabled},
            #{syncSource}, #{syncTime}
        )
    </insert>

    <!-- 更新景点信息 -->
    <update id="updateById">
        UPDATE attraction
        <set>
            <if test="name != null">name = #{name},</if>
            <if test="location != null">location = #{location},</if>
            <if test="province != null">province = #{province},</if>
            <if test="city != null">city = #{city},</if>
            <if test="district != null">district = #{district},</if>
            <if test="address != null">address = #{address},</if>
            <if test="description != null">description = #{description},</if>
            <if test="images != null">images = #{images, typeHandler=com.travel.mapper.typehandler.JsonListTypeHandler},</if>
            <if test="videoUrl != null">video_url = #{videoUrl},</if>
            <if test="openTime != null">open_time = #{openTime},</if>
            <if test="contactPhone != null">contact_phone = #{contactPhone},</if>
            <if test="longitude != null">longitude = #{longitude},</if>
            <if test="latitude != null">latitude = #{latitude},</if>
            <if test="ticketPrice != null">ticket_price = #{ticketPrice},</if>
            <if test="ticketStock != null">ticket_stock = #{ticketStock},</if>
            <if test="validPeriod != null">valid_period = #{validPeriod},</if>
            <if test="status != null">status = #{status},</if>
            <if test="rating != null">rating = #{rating},</if>
            <if test="tags != null">tags = #{tags, typeHandler=com.travel.mapper.typehandler.JsonListTypeHandler},</if>
            <if test="admissionNotice != null">admission_notice = #{admissionNotice},</if>
            <if test="admissionNoticeUrl != null">admission_notice_url = #{admissionNoticeUrl},</if>
            <if test="goldenSummitEnabled != null">golden_summit_enabled = #{goldenSummitEnabled},</if>
            <if test="syncSource != null">sync_source = #{syncSource},</if>
            <if test="syncTime != null">sync_time = #{syncTime},</if>
        </set>
        WHERE id = #{id}
    </update>

    <!-- 删除景点（物理删除） -->
    <delete id="deleteById">
        DELETE FROM attraction WHERE id = #{id}
    </delete>

    <!-- 检查景点是否有关联订单 -->
    <select id="countOrdersByAttractionId" resultType="long">
        SELECT COUNT(*)
        FROM order_item
        WHERE item_type = 'ATTRACTION' AND item_id = #{attractionId}
    </select>

</mapper>
