import{j as q,T as C,ac as G,a4 as L,E as c}from"./element-plus-BQiw23q9.js";import{a5 as R}from"./vendor-x5eiJF7K.js";import{g as D}from"./index-DBeEaY1O.js";import{_ as V}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{c as E,r as g,v as B,x as W,G as d,$ as w,A as H,o as J,B as f,C as I,u as F,D as K}from"./vue-vendor-Cs8obalv.js";const O={class:"image-upload-container"},Q=["src"],X={__name:"ImageUpload",props:{modelValue:{type:[Array,String],default:()=>[]},limit:{type:Number,default:9},disabled:{type:Boolean,default:!1},maxSize:{type:Number,default:5}},emits:["update:modelValue","change"],setup(v,{expose:S,emit:U}){const u=v,m=U,j=E(()=>"/api/v1/common/file/upload/image"),A=E(()=>({Authorization:`Bearer ${D()}`})),p=g(null),s=g([]),y=g(!1),h=g("");let r=null;B(()=>u.modelValue,e=>{u.limit===1?e&&typeof e=="string"&&e.trim()!==""?s.value=[{uid:"image-1",name:"image.jpg",url:e,status:"success"}]:Array.isArray(e)&&e.length>0?s.value=[{uid:"image-1",name:"image.jpg",url:e[0],status:"success"}]:s.value=[]:Array.isArray(e)?s.value=e.filter(t=>t&&typeof t=="string"&&t.trim()!=="").map((t,a)=>({uid:`image-${a}`,name:`image-${a}.jpg`,url:t,status:"success"})):typeof e=="string"&&e.trim()!==""?s.value=[{uid:"image-0",name:"image.jpg",url:e,status:"success"}]:s.value=[]},{immediate:!0,deep:!0});const _=()=>{const e=s.value.filter(t=>t.status==="success").map(t=>{var a,l,o;return t.url||((l=(a=t.response)==null?void 0:a.data)==null?void 0:l.url)||((o=t.response)==null?void 0:o.data)}).filter(Boolean);if(u.limit===1){const t=e.length>0?e[0]:"";m("update:modelValue",t),m("change",t)}else{const t=Array.isArray(e)?e:[];m("update:modelValue",t),m("change",t)}},$=e=>{const t=e.type.startsWith("image/"),a=["image/jpeg","image/jpg","image/png","image/webp"].includes(e.type),l=e.size/1024/1024<u.maxSize;return!t||!a?(c.error("只能上传图片文件（JPG、PNG、WebP格式）"),!1):l?!0:(c.error(`图片大小不能超过 ${u.maxSize}MB`),!1)},k=(e,t)=>{var a;if(console.log("上传成功响应:",e),e&&e.code===200){const l=((a=e.data)==null?void 0:a.url)||e.data,o=typeof l=="string"?l:"";t.url=o,t.status="success";const n=s.value.findIndex(b=>b.uid===t.uid);n>-1?s.value[n]=t:s.value.push(t),u.limit===1&&s.value.length>1&&(s.value=[t]),_(),c.success("上传成功")}else t.status="error",c.error((e==null?void 0:e.message)||"上传失败")},T=(e,t)=>{t.status="error",console.error("上传失败:",e),c.error("上传失败，请重试")},z=e=>{const t=s.value.findIndex(a=>a.uid===e.uid);t>-1&&(s.value.splice(t,1),_())},N=e=>{var a,l,o;const t=e.url||((l=(a=e.response)==null?void 0:a.data)==null?void 0:l.url)||((o=e.response)==null?void 0:o.data)||"";h.value=t,y.value=!0},M=e=>{console.error("图片加载失败:",h.value),c.error("图片加载失败")},P=()=>{c.warning(`最多只能上传 ${u.limit} 张图片`)},x=()=>{u.limit!==1&&d(()=>{var t,a;i();const e=(a=(t=p.value)==null?void 0:t.$el)==null?void 0:a.querySelector(".el-upload-list--picture-card");!e||r||(r=R.create(e,{animation:300,handle:".el-upload-list__item",draggable:".el-upload-list__item",onEnd:l=>{const{oldIndex:o,newIndex:n}=l;if(o!==n){const b=s.value.splice(o,1)[0];s.value.splice(n,0,b),_()}i()}}))})},i=()=>{d(()=>{var t;if(!((t=p.value)!=null&&t.$el))return;const e=p.value.$el.querySelector(".el-upload--picture-card");if(e){e.style.pointerEvents="auto",e.style.cursor="pointer",e.style.zIndex="10";const a=e.querySelector('input[type="file"]');a&&(a.style.pointerEvents="auto",a.style.cursor="pointer")}})};return B(()=>s.value.length,()=>{r&&(r.destroy(),r=null),d(()=>{i(),x()})},{flush:"post"}),S({refresh:()=>{r&&(r.destroy(),r=null),d(()=>{i(),setTimeout(()=>{i(),x()},100)})}}),W(()=>{d(()=>{i(),setTimeout(()=>{i(),x(),setTimeout(()=>{i()},100),setTimeout(()=>{i()},300)},300)})}),w(()=>{r&&(r.destroy(),r=null)}),(e,t)=>{const a=q,l=G,o=L;return J(),H("div",O,[f(l,{ref_key:"uploadRef",ref:p,action:j.value,headers:A.value,"list-type":"picture-card","file-list":s.value,"on-preview":N,"on-remove":z,"on-success":k,"on-error":T,"before-upload":$,limit:v.limit,"on-exceed":P,disabled:v.disabled,accept:"image/jpeg,image/jpg,image/png,image/webp"},{default:I(()=>[f(a,null,{default:I(()=>[f(F(C))]),_:1})]),_:1},8,["action","headers","file-list","limit","disabled"]),f(o,{modelValue:y.value,"onUpdate:modelValue":t[0]||(t[0]=n=>y.value=n),title:"图片预览",width:"800px"},{default:I(()=>[K("img",{src:h.value,style:{width:"100%"},alt:"预览",onError:M},null,40,Q)]),_:1},8,["modelValue"])])}}},le=V(X,[["__scopeId","data-v-42765ee3"]]);export{le as I};
