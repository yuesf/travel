<!--å•†å“å¡ç‰‡ç»„ä»¶-->
<view class="product-card" bindtap="onCardTap">
  <!-- å•†å“å›¾ç‰‡ -->
  <view class="product-image-wrapper">
    <image
      class="product-image"
      src="{{imageErrorMap[product.id] ? defaultProductImage : (product.image || product.coverImage || defaultProductImage)}}"
      mode="aspectFill"
      binderror="onImageError"
      data-product-id="{{product.id}}"
      data-productId="{{product.id}}"
      data-is-default="{{imageErrorMap[product.id] ? 'true' : 'false'}}"
    />
    <!-- æ ‡ç­¾ -->
    <view wx:if="{{product.tag}}" class="product-tag">
      {{product.tag}}
    </view>
  </view>

  <!-- å•†å“ä¿¡æ¯ -->
  <view class="product-info">
    <!-- æ ‡é¢˜ -->
    <view class="product-title">{{product.name || product.title}}</view>

    <!-- æè¿°ï¼ˆå¯Œæ–‡æœ¬ï¼‰- ä»…å•†å“ç±»å‹æ˜¾ç¤º -->
    <view wx:if="{{productType === 'PRODUCT' && formattedDescription}}" class="product-desc">
      <rich-text nodes="{{formattedDescription}}"></rich-text>
    </view>

    <!-- é…’åº—è®¾æ–½ï¼ˆä»…é…’åº—ç±»å‹æ˜¾ç¤ºï¼‰ -->
    <view wx:if="{{productType === 'HOTEL' && product.facilities && product.facilities.length > 0}}" class="product-facilities">
      <text class="facilities-label">è®¾æ–½ï¼š</text>
      <text class="facilities-text">{{product.facilities.join('ã€')}}</text>
    </view>

    <!-- æ™¯ç‚¹è¯„çº§ï¼ˆä»…æ™¯ç‚¹ç±»å‹æ˜¾ç¤ºï¼‰ -->
    <view wx:if="{{productType === 'ATTRACTION' && product.rating}}" class="product-rating-info">
      <text class="rating-label">è¯„çº§ï¼š</text>
      <text class="rating-value-text">{{product.rating}}</text>
    </view>

    <!-- åœ°å€ä¿¡æ¯ï¼ˆæ™¯ç‚¹/é…’åº—ï¼‰ -->
    <view wx:if="{{(productType === 'ATTRACTION' || productType === 'HOTEL') && product.address}}" class="product-location">
      <text class="location-icon">ğŸ“</text>
      <text class="location-text">{{product.address}}</text>
    </view>

    <!-- åº•éƒ¨ä¿¡æ¯æ  -->
    <view class="product-footer">
      <!-- ä»·æ ¼ -->
      <view wx:if="{{showPrice}}" class="product-price">
        <text class="price-symbol">Â¥</text>
        <text class="price-value">{{product.price || product.minPrice || 0}}</text>
        <text wx:if="{{product.originalPrice && product.originalPrice > (product.price || product.minPrice)}}" class="price-original">
          Â¥{{product.originalPrice}}
        </text>
      </view>

      <!-- è¯„åˆ†å’Œæ“ä½œæŒ‰é’® -->
      <view class="product-footer-right">
        <!-- è¯„åˆ† -->
        <view wx:if="{{showRating && product.rating}}" class="product-rating">
          <text class="rating-icon">â­</text>
          <text class="rating-value">{{product.rating}}</text>
          <text wx:if="{{product.reviewCount}}" class="rating-count">
            ({{product.reviewCount}})
          </text>
        </view>
        
        <!-- è´­ç‰©è½¦æŒ‰é’®ï¼ˆä»…å•†å“ç±»å‹æ˜¾ç¤ºï¼‰ -->
        <view wx:if="{{productType === 'PRODUCT'}}" class="product-cart-icon" catchtap="onAddToCart">
          <text class="cart-icon">ğŸ›’</text>
        </view>
        
        <!-- ç«‹å³é¢„è®¢æŒ‰é’®ï¼ˆæ™¯ç‚¹å’Œé…’åº—ç±»å‹æ˜¾ç¤ºï¼‰ -->
        <view 
          wx:if="{{(productType === 'ATTRACTION' || productType === 'HOTEL') && product && product.id}}" 
          class="product-book-btn" 
          catchtap="onBookNow"
          catchtouchstart="onBookNowTouchStart"
          catchtouchend="onBookNowTouchEnd"
          data-product-id="{{product.id}}"
          data-product-type="{{productType}}"
        >
          <text class="book-btn-text">ç«‹å³é¢„è®¢</text>
        </view>
      </view>
    </view>
  </view>

  <!-- è§„æ ¼é€‰æ‹©å¼¹çª—ï¼ˆå•†å“ï¼‰ -->
  <view wx:if="{{showSpecModal && productType === 'PRODUCT'}}" class="spec-modal-mask" bindtap="onCloseSpecModal">
    <view class="spec-modal" catchtap="true">
      <view class="spec-modal-header">
        <text class="spec-modal-title">é€‰æ‹©è§„æ ¼</text>
        <text class="spec-modal-close" bindtap="onCloseSpecModal">âœ•</text>
      </view>
      
      <scroll-view class="spec-modal-content" scroll-y="true">
        <!-- å•†å“ä¿¡æ¯ -->
        <view class="spec-product-info">
          <image 
            wx:if="{{productDetail && productDetail.images && productDetail.images.length > 0}}" 
            class="spec-product-image" 
            src="{{productDetail.images[0] || defaultProductImage}}" 
            mode="aspectFill"
            binderror="onSpecImageError"
            data-type="detail"
          />
          <image 
            wx:elif="{{product.image || product.coverImage}}" 
            class="spec-product-image" 
            src="{{product.image || product.coverImage || defaultProductImage}}" 
            mode="aspectFill"
            binderror="onSpecImageError"
            data-type="product"
          />
          <image 
            wx:else
            class="spec-product-image" 
            src="{{defaultProductImage}}" 
            mode="aspectFill"
          />
          <view class="spec-product-details">
            <text class="spec-product-name">{{productDetail ? productDetail.name : product.name}}</text>
            <text class="spec-product-price">Â¥{{productDetail ? productDetail.price : (product.price || product.minPrice || 0)}}</text>
          </view>
        </view>
        
        <!-- è§„æ ¼é€‰æ‹© -->
        <view wx:if="{{productDetail && productDetail.specList && productDetail.specList.length > 0}}" class="spec-list">
          <view wx:for="{{productDetail.specList}}" wx:for-item="specItem" wx:key="key" class="spec-group">
            <view class="spec-group-title">{{specItem.key}}</view>
            <view class="spec-options">
              <!-- éå†è§„æ ¼é€‰é¡¹ -->
              <view
                wx:for="{{specItem.value}}" wx:for-item="option"
                wx:key="*this"
                class="spec-option {{selectedSpec[specItem.key] === option ? 'active' : ''}}"
                data-spec-key="{{specItem.key}}"
                data-spec-value="{{option}}"
                bindtap="onSelectSpec"
              >
                <text class="spec-option-text">{{option}}</text>
              </view>
            </view>
          </view>
        </view>
      </scroll-view>

      <!-- è§„æ ¼é€‰æ‹©æç¤ºä¿¡æ¯ -->
      <view wx:if="{{showSpecTip}}" class="spec-tip">
        <text class="spec-tip-text">{{specTipText}}</text>
      </view>

      <!-- æ•°é‡é€‰æ‹©å’Œæ“ä½œæŒ‰é’® -->
      <view class="spec-modal-footer">
        <view class="quantity-selector">
          <text class="quantity-label">æ•°é‡ï¼š</text>
          <view class="quantity-controls">
            <view class="quantity-btn minus" bindtap="onDecreaseQuantity">-</view>
            <text class="quantity-value">{{quantity}}</text>
            <view class="quantity-btn plus" bindtap="onIncreaseQuantity">+</view>
          </view>
        </view>
        <view class="spec-modal-actions">
          <view class="spec-modal-btn cancel" bindtap="onCloseSpecModal">å–æ¶ˆ</view>
          <view class="spec-modal-btn confirm" bindtap="onAddToCart">ç¡®å®š</view>
        </view>
      </view>
    </view>
  </view>

  <!-- æ™¯ç‚¹é¢„è®¢å¼¹çª— -->
  <view wx:if="{{showAttractionModal && productType === 'ATTRACTION'}}" class="room-modal-mask" bindtap="onCloseAttractionModal">
    <view class="room-modal" catchtap="true">
      <view class="room-modal-header">
        <text class="room-modal-title">æ™¯ç‚¹é¢„è®¢</text>
        <text class="room-modal-close" bindtap="onCloseAttractionModal">âœ•</text>
      </view>
      
      <scroll-view class="room-modal-content" scroll-y="true">
        <!-- æ™¯ç‚¹ä¿¡æ¯ -->
        <view class="room-modal-info">
          <image 
            wx:if="{{product.image || product.coverImage}}" 
            class="room-modal-image" 
            src="{{product.image || product.coverImage}}" 
            mode="aspectFill" 
          />
          <view class="room-modal-details">
            <text class="room-modal-name">{{product.name}}</text>
            <text class="room-modal-price">Â¥{{product.price || 0}}</text>
          </view>
        </view>
        
        <!-- æ—¥æœŸé€‰æ‹© -->
        <view class="room-modal-dates">
          <view class="date-item">
            <text class="date-label">ä½¿ç”¨æ—¥æœŸ</text>
            <picker mode="date" value="{{useDate}}" start="{{minDate}}" bindchange="onUseDateChange">
              <view class="date-picker">
                <text class="date-text">{{useDate || 'è¯·é€‰æ‹©'}}</text>
                <text class="date-arrow">â€º</text>
              </view>
            </picker>
          </view>
        </view>
      </scroll-view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="room-modal-footer">
        <view class="quantity-selector">
          <text class="quantity-label">æ•°é‡ï¼š</text>
          <view class="quantity-controls">
            <view class="quantity-btn minus" bindtap="onDecreaseQuantity">-</view>
            <text class="quantity-value">{{quantity}}</text>
            <view class="quantity-btn plus" bindtap="onIncreaseQuantity">+</view>
          </view>
        </view>
        <view class="room-modal-actions">
          <view class="room-modal-btn cancel" bindtap="onCloseAttractionModal">å–æ¶ˆ</view>
          <view class="room-modal-btn confirm" bindtap="onConfirmAttractionBooking">ç¡®å®š</view>
        </view>
      </view>
    </view>
  </view>

  <!-- é…’åº—é¢„è®¢å¼¹çª— -->
  <view wx:if="{{showHotelModal && productType === 'HOTEL'}}" class="room-modal-mask" bindtap="onCloseHotelModal">
    <view class="room-modal" catchtap="true">
      <view class="room-modal-header">
        <text class="room-modal-title">é…’åº—é¢„è®¢</text>
        <text class="room-modal-close" bindtap="onCloseHotelModal">âœ•</text>
      </view>
      
      <scroll-view class="room-modal-content" scroll-y="true">
        <!-- é…’åº—ä¿¡æ¯ -->
        <view class="room-modal-info">
          <image 
            wx:if="{{product.image || product.coverImage}}" 
            class="room-modal-image" 
            src="{{product.image || product.coverImage}}" 
            mode="aspectFill" 
          />
          <view class="room-modal-details">
            <text class="room-modal-name">{{product.name}}</text>
            <text class="room-modal-price">Â¥{{product.price || product.minPrice || 0}}èµ·</text>
          </view>
        </view>
        
        <!-- æ—¥æœŸé€‰æ‹© -->
        <view class="room-modal-dates">
          <view class="date-item">
            <text class="date-label">å…¥ä½æ—¥æœŸ</text>
            <picker mode="date" value="{{checkInDate}}" start="{{minDate}}" bindchange="onCheckInDateChange">
              <view class="date-picker">
                <text class="date-text {{checkInDate ? '' : 'placeholder'}}">{{checkInDate || 'è¯·é€‰æ‹©'}}</text>
                <text class="date-arrow">â€º</text>
              </view>
            </picker>
          </view>
          <view class="date-item">
            <text class="date-label">é€€æˆ¿æ—¥æœŸ</text>
            <picker mode="date" value="{{checkOutDate}}" start="{{checkInDate || minDate}}" bindchange="onCheckOutDateChange">
              <view class="date-picker">
                <text class="date-text {{checkOutDate ? '' : 'placeholder'}}">{{checkOutDate || 'è¯·é€‰æ‹©'}}</text>
                <text class="date-arrow">â€º</text>
              </view>
            </picker>
          </view>
        </view>
        
        <!-- æˆ¿å‹é€‰æ‹© -->
        <view wx:if="{{hotelDetail && hotelDetail.rooms}}" class="room-modal-room-selector">
          <view class="date-item">
            <text class="date-label">æˆ¿å‹</text>
            <view class="date-picker" bindtap="onToggleRoomList">
              <text class="date-text {{selectedRoom ? '' : 'placeholder'}}">
                {{selectedRoom ? (selectedRoom.name || selectedRoom.roomType) : 'è¯·é€‰æ‹©æˆ¿å‹'}}
              </text>
              <text class="date-arrow {{showRoomList ? 'rotate' : ''}}">â€º</text>
            </view>
          </view>
          
          <!-- æˆ¿å‹åˆ—è¡¨ï¼ˆå¯å±•å¼€/æ”¶èµ·ï¼‰ -->
          <view wx:if="{{showRoomList}}" class="room-modal-rooms">
            <view
              wx:for="{{hotelDetail.rooms}}"
              wx:key="id"
              class="room-modal-item {{selectedRoom && selectedRoom.id === item.id ? 'active' : ''}}"
              data-room="{{item}}"
              bindtap="onSelectRoom"
            >
              <view class="room-modal-item-info">
                <text class="room-modal-item-name">{{item.name || item.roomType}}</text>
                <text wx:if="{{item.description}}" class="room-modal-item-desc">{{item.description}}</text>
                <view wx:if="{{item.features && item.features.length > 0}}" class="room-modal-item-features">
                  <text wx:for="{{item.features}}" wx:key="index" wx:for-item="feature" class="room-feature-tag">{{feature}}</text>
                </view>
              </view>
              <view class="room-modal-item-right">
                <view class="room-modal-item-price">
                  <text class="room-modal-item-price-text">Â¥{{item.price}}</text>
                  <text class="room-modal-item-price-unit">/æ™š</text>
                </view>
                <view wx:if="{{selectedRoom && selectedRoom.id === item.id}}" class="room-modal-item-check">âœ“</view>
              </view>
            </view>
          </view>
          
          <!-- å·²é€‰æ‹©æˆ¿å‹ä¿¡æ¯å±•ç¤º -->
          <view wx:if="{{selectedRoom && !showRoomList}}" class="room-selected-info">
            <view class="room-selected-content">
              <text class="room-selected-name">{{selectedRoom.name || selectedRoom.roomType}}</text>
              <text wx:if="{{selectedRoom.description}}" class="room-selected-desc">{{selectedRoom.description}}</text>
            </view>
            <view class="room-selected-price">
              <text class="room-selected-price-text">Â¥{{selectedRoom.price}}</text>
              <text class="room-selected-price-unit">/æ™š</text>
            </view>
          </view>
        </view>
      </scroll-view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="room-modal-footer">
        <view class="quantity-selector">
          <text class="quantity-label">æ•°é‡ï¼š</text>
          <view class="quantity-controls">
            <view class="quantity-btn minus" bindtap="onDecreaseQuantity">-</view>
            <text class="quantity-value">{{quantity}}</text>
            <view class="quantity-btn plus" bindtap="onIncreaseQuantity">+</view>
          </view>
        </view>
        <view class="room-modal-actions">
          <view class="room-modal-btn cancel" bindtap="onCloseHotelModal">å–æ¶ˆ</view>
          <view class="room-modal-btn confirm" bindtap="onConfirmHotelBooking">ç¡®å®š</view>
        </view>
      </view>
    </view>
  </view>
</view>
