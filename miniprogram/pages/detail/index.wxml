<!--è¯¦æƒ…é¡µ-->
<view class="page-container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-container">
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- å†…å®¹åŒºåŸŸ -->
  <view wx:elif="{{detail}}" class="content-container">
    <!-- å›¾ç‰‡/è§†é¢‘è½®æ’­åŒºåŸŸ -->
    <view class="swiper-container">
      <swiper
        class="swiper"
        indicator-dots="{{mediaList.length > 1}}"
        indicator-color="rgba(255, 255, 255, 0.5)"
        indicator-active-color="#ffffff"
        autoplay="{{mediaList.length > 1}}"
        interval="{{3000}}"
        duration="{{500}}"
        circular="{{true}}"
        bindchange="onSwiperChange"
      >
        <swiper-item wx:for="{{mediaList}}" wx:key="index">
          <!-- å›¾ç‰‡ -->
          <image
            wx:if="{{item.type === 'image'}}"
            class="swiper-image"
            src="{{item.url}}"
            mode="aspectFill"
            data-index="{{index}}"
            bindtap="onImageTap"
          />
          <!-- è§†é¢‘ -->
          <video
            wx:elif="{{item.type === 'video'}}"
            class="swiper-video"
            src="{{item.url}}"
            poster="{{item.poster}}"
            controls="{{true}}"
            show-center-play-btn="{{true}}"
            enable-play-gesture="{{true}}"
            bindplay="onVideoPlay"
            bindfullscreenchange="onVideoFullscreenChange"
          />
        </swiper-item>
      </swiper>
      <!-- è½®æ’­æŒ‡ç¤ºå™¨ -->
      <view wx:if="{{mediaList.length > 1}}" class="swiper-indicator">
        <text class="swiper-indicator-text">{{currentSwiperIndex + 1}}/{{mediaList.length}}</text>
      </view>
    </view>

    <!-- åŸºæœ¬ä¿¡æ¯åŒºåŸŸ -->
    <view class="info-section">
      <!-- åç§°å’Œä»·æ ¼ -->
      <view class="info-header">
        <text class="info-name">{{detail.name}}</text>
        <view class="info-price-row">
          <text class="info-price">Â¥{{detail.price}}</text>
          <text wx:if="{{detail.originalPrice}}" class="info-original-price">Â¥{{detail.originalPrice}}</text>
        </view>
      </view>

      <!-- è¯„åˆ†å’Œä½ç½® -->
      <view class="info-meta">
        <view wx:if="{{detail.rating}}" class="info-rating">
          <text class="info-rating-text">è¯„åˆ†ï¼š{{detail.rating}}</text>
          <text class="info-rating-star">â˜…</text>
        </view>
        <view wx:if="{{detail.location}}" class="info-location">
          <text class="info-location-icon">ğŸ“</text>
          <text class="info-location-text">{{detail.location}}</text>
        </view>
      </view>

      <!-- åº“å­˜ä¿¡æ¯ -->
      <view wx:if="{{detail.stock !== undefined}}" class="info-stock">
        <text class="info-stock-text">åº“å­˜ï¼š{{detail.stock}}ä»¶</text>
      </view>

      <!-- é…’åº—ç‰¹æœ‰ä¿¡æ¯ -->
      <view wx:if="{{type === 'hotel' && detail.starLevel}}" class="info-hotel">
        <text class="info-hotel-text">æ˜Ÿçº§ï¼š{{detail.starLevel}}æ˜Ÿ</text>
      </view>
    </view>

    <!-- æ™¯ç‚¹è¯¦æƒ…ä¸» Tabï¼ˆé—¨ç¥¨é¢„è®¢ / æ™¯åŒºä»‹ç»ï¼‰ -->
    <view wx:if="{{type === 'attraction'}}" class="booking-main-tabs">
      <view
        class="booking-main-tab {{bookingMainTab === 'booking' ? 'active' : ''}}"
        data-tab="booking"
        bindtap="onBookingMainTabChange"
      >
        <text class="booking-main-tab-text">é—¨ç¥¨é¢„è®¢</text>
      </view>
      <view
        class="booking-main-tab {{bookingMainTab === 'intro' ? 'active' : ''}}"
        data-tab="intro"
        bindtap="onBookingMainTabChange"
      >
        <text class="booking-main-tab-text">æ™¯åŒºä»‹ç»</text>
      </view>
    </view>

    <!-- é—¨ç¥¨é¢„è®¢åŒºåŸŸï¼ˆä»…æ™¯ç‚¹ & é—¨ç¥¨é¢„è®¢ Tab ä¸‹æ˜¾ç¤ºï¼‰ -->
    <view wx:if="{{type === 'attraction' && bookingMainTab === 'booking'}}" class="booking-section">
      <!-- å¯è®¢æ—¥æœŸ -->
      <view class="booking-date-section">
        <view class="booking-date-title">å¯è®¢æ—¥æœŸ</view>
        <view class="date-tabs">
          <view
            wx:for="{{dateOptions}}"
            wx:key="fullDate"
            class="date-tab-item {{selectedDateIndex === index ? 'active' : ''}}"
            data-index="{{index}}"
            bindtap="onSelectUseDateTab"
          >
            <text class="date-tab-label">{{item.label}}</text>
            <text class="date-tab-date">{{item.monthDay}}</text>
          </view>
          <!-- æ›´å¤šæ—¥æœŸ -->
          <picker mode="date" value="{{useDate}}" start="{{minDate}}" bindchange="onUseDateChange">
            <view class="date-tab-item more-date">
              <text class="date-tab-label">æ›´å¤š</text>
              <text class="date-tab-date">æ—¥æœŸ â€º</text>
            </view>
          </picker>
        </view>
      </view>

      <!-- ç¥¨ç§åˆ†ç±» + ç¥¨ç§åˆ—è¡¨ -->
      <view wx:if="{{detail.ticketCategories && detail.ticketCategories.length}}" class="ticket-categories-section">
        <view
          wx:for="{{detail.ticketCategories}}"
          wx:for-item="cat"
          wx:key="id"
          class="ticket-category"
        >
          <view class="ticket-category-header">
            <text class="ticket-category-name">{{cat.name}}</text>
            <text wx:if="{{cat.description}}" class="ticket-category-desc">{{cat.description}}</text>
          </view>
          <view wx:if="{{cat.tickets && cat.tickets.length}}" class="ticket-category-list">
            <view
              wx:for="{{cat.tickets}}"
              wx:for-item="ticket"
              wx:key="id"
              class="ticket-card"
            >
              <view class="ticket-card-info">
                <text class="ticket-card-name">{{ticket.name}}</text>
                <text wx:if="{{ticket.includedAttractions && ticket.includedAttractions.length}}" class="ticket-card-desc">
                  {{ticket.includedAttractions.join('ã€')}}
                </text>
              </view>
              <view class="ticket-card-right">
                <view class="ticket-card-price-row">
                  <text class="ticket-card-price">Â¥{{ticket.price || detail.price}}</text>
                </view>
                <!-- ç¥¨ç§æ•°é‡é€‰æ‹© -->
                <view class="ticket-quantity-row">
                  <text class="ticket-quantity-label">æ•°é‡ï¼š</text>
                  <view class="quantity-controls">
                    <view
                      class="quantity-btn minus"
                      data-ticket-id="{{ticket.id}}"
                      bindtap="onDecreaseTicketQuantity"
                    >-</view>
                    <text class="quantity-value">
                      {{ticketQuantities[ticket.id] || 1}}
                    </text>
                    <view
                      class="quantity-btn plus"
                      data-ticket-id="{{ticket.id}}"
                      bindtap="onIncreaseTicketQuantity"
                    >+</view>
                  </view>
                </view>
                <view
                  class="ticket-card-book-btn"
                  data-ticket="{{ticket}}"
                  bindtap="onTicketBookTap"
                >
                  <text class="ticket-card-book-text">é¢„è®¢</text>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- æ•°é‡é€‰æ‹© -->
      <view class="booking-quantity-row">
        <text class="quantity-label">æ•°é‡ï¼š</text>
        <view class="quantity-controls">
          <view class="quantity-btn minus" bindtap="onDecreaseQuantity">-</view>
          <text class="quantity-value">{{quantity}}</text>
          <view class="quantity-btn plus" bindtap="onIncreaseQuantity">+</view>
        </view>
      </view>
    </view>

    <!-- æ™¯åŒºä»‹ç» / é…’åº— / å•†å“è¯¦æƒ…åŒºåŸŸ -->
    <view wx:if="{{type !== 'attraction' || bookingMainTab === 'intro'}}" class="detail-section">
      <!-- æ ‡ç­¾é¡µ -->
      <view class="tabs-container">
        <view
          wx:for="{{tabs}}"
          wx:key="index"
          class="tab-item {{activeTab === index ? 'active' : ''}}"
          data-index="{{index}}"
          bindtap="onTabChange"
        >
          <text class="tab-text">{{item}}</text>
        </view>
      </view>

      <!-- è¯¦æƒ…å†…å®¹ -->
      <view class="detail-content">
        <!-- è¯¦æƒ…æ ‡ç­¾é¡µ -->
        <view wx:if="{{activeTab === 0}}" class="detail-tab-content">
          <!-- è¯¦æƒ…æè¿°ï¼ˆå¯Œæ–‡æœ¬ï¼‰ -->
          <view wx:if="{{detail.description}}" class="detail-description">
            <rich-text nodes="{{detail.description}}"></rich-text>
          </view>

          <!-- è®¾æ–½/æœåŠ¡åˆ—è¡¨ï¼ˆé…’åº—ï¼‰ -->
          <view wx:if="{{type === 'hotel' && detail.facilities}}" class="detail-facilities">
            <view class="detail-facilities-title">è®¾æ–½æœåŠ¡</view>
            <view class="detail-facilities-list">
              <view
                wx:for="{{detail.facilities}}"
                wx:key="index"
                class="facility-item"
              >
                <text class="facility-text">{{item}}</text>
              </view>
            </view>
          </view>

          <!-- æˆ¿å‹åˆ—è¡¨ï¼ˆé…’åº—ï¼‰ -->
          <view wx:if="{{type === 'hotel' && detail.rooms && detail.rooms.length}}" class="detail-rooms">
            <view class="detail-rooms-title">æˆ¿å‹é€‰æ‹©</view>
            <view class="detail-rooms-list">
              <view
                wx:for="{{detail.rooms}}"
                wx:key="id"
                class="room-item"
                data-room="{{item}}"
                bindtap="onSelectRoom"
              >
                <view class="room-info">
                  <text class="room-name">{{item.name}}</text>
                  <text class="room-desc">{{item.description}}</text>
                  <view class="room-features">
                    <text wx:for="{{item.features}}" wx:key="index" class="room-feature">{{item}}</text>
                  </view>
                </view>
                <view class="room-price">
                  <text class="room-price-text">Â¥{{item.price}}</text>
                  <text class="room-price-unit">/æ™š</text>
                </view>
              </view>
            </view>
          </view>
        </view>

        <!-- è¯„ä»·æ ‡ç­¾é¡µ -->
        <view wx:if="{{activeTab === 1}}" class="detail-tab-content">
          <view class="empty-content">
            <text class="empty-text">æš‚æ— è¯„ä»·</text>
          </view>
        </view>

        <!-- é¡»çŸ¥æ ‡ç­¾é¡µ -->
        <view wx:if="{{activeTab === 2}}" class="detail-tab-content">
          <view wx:if="{{detail.notice}}" class="detail-notice">
            <rich-text nodes="{{detail.notice}}"></rich-text>
          </view>
          <view wx:else class="empty-content">
            <text class="empty-text">æš‚æ— é¡»çŸ¥</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view wx:if="{{!loading && !detail}}" class="empty-container">
    <text class="empty-text">æš‚æ— å•†å“ä¿¡æ¯</text>
  </view>

  <!-- åº•éƒ¨æ“ä½œæ ï¼ˆå›ºå®šï¼‰ -->
  <view wx:if="{{detail}}" class="action-bar">
    <!-- å·¦ä¾§å¯¼èˆªå›¾æ ‡ -->
    <view class="action-nav-icons">
      <view class="nav-icon" bindtap="onGoHome">
        <text class="nav-icon-text">ğŸ </text>
        <text class="nav-icon-label">é¦–é¡µ</text>
      </view>
      <view class="nav-icon" bindtap="onGoCart">
        <text class="nav-icon-text">ğŸ›’</text>
        <text class="nav-icon-label">è´­ç‰©è½¦</text>
      </view>
    </view>
    
    <!-- å³ä¾§æ“ä½œæŒ‰é’® -->
    <view class="action-buttons">
      <!-- éæ™¯ç‚¹ï¼šä¿ç•™åŠ å…¥è´­ç‰©è½¦å’Œç«‹å³è´­ä¹° -->
      <view wx:if="{{type !== 'attraction'}}" class="action-btn cart" bindtap="onAddToCart">
        <text class="action-btn-text">åŠ å…¥è´­ç‰©è½¦</text>
      </view>
      <view wx:if="{{type !== 'attraction'}}" class="action-btn buy" bindtap="onBuyNow">
        <text class="action-btn-text">ç«‹å³è´­ä¹°</text>
      </view>
    </view>
  </view>

  <!-- æ™¯ç‚¹é¢„è®¢å¼¹çª— -->
  <view wx:if="{{showAttractionModal && type === 'attraction'}}" class="room-modal-mask" bindtap="onCloseAttractionModal" catchtouchmove="onPreventMove">
    <view class="room-modal" catchtap="true">
      <view class="room-modal-header">
        <text class="room-modal-title">é€‰æ‹©ä½¿ç”¨æ—¥æœŸ</text>
        <text class="room-modal-close" bindtap="onCloseAttractionModal">âœ•</text>
      </view>
      
      <scroll-view class="room-modal-content" scroll-y="true">
        <!-- æ—¥æœŸé€‰æ‹© -->
        <view class="room-modal-dates">
          <view class="date-item">
            <text class="date-label">ä½¿ç”¨æ—¥æœŸ</text>
            <picker mode="date" value="{{useDate}}" start="{{minDate}}" bindchange="onUseDateChange">
              <view class="date-picker">
                <text class="date-text">{{useDate || 'è¯·é€‰æ‹©'}}</text>
                <text class="date-arrow">â€º</text>
              </view>
            </picker>
          </view>
        </view>
      </scroll-view>

      <!-- æ•°é‡é€‰æ‹© -->
      <view class="room-modal-footer">
        <view class="quantity-selector">
          <text class="quantity-label">æ•°é‡ï¼š</text>
          <view class="quantity-controls">
            <view class="quantity-btn minus" bindtap="onDecreaseQuantity">-</view>
            <text class="quantity-value">{{quantity}}</text>
            <view class="quantity-btn plus" bindtap="onIncreaseQuantity">+</view>
          </view>
        </view>
        <view class="room-modal-actions">
          <view class="room-modal-btn cancel" bindtap="onCloseAttractionModal">å–æ¶ˆ</view>
          <view class="room-modal-btn confirm" bindtap="onBuyNow">ç¡®å®š</view>
        </view>
      </view>
    </view>
  </view>

  <!-- æˆ¿å‹é€‰æ‹©å¼¹çª—ï¼ˆé…’åº—ï¼‰ -->
  <view wx:if="{{showRoomModal && type === 'hotel'}}" class="room-modal-mask" bindtap="onCloseRoomModal" catchtouchmove="onPreventMove">
    <view class="room-modal" catchtap="true">
      <view class="room-modal-header">
        <text class="room-modal-title">é€‰æ‹©æˆ¿å‹</text>
        <text class="room-modal-close" bindtap="onCloseRoomModal">âœ•</text>
      </view>
      
      <scroll-view class="room-modal-content" scroll-y="true">
        <!-- æ—¥æœŸé€‰æ‹© -->
        <view class="room-modal-dates">
          <view class="date-item">
            <text class="date-label">å…¥ä½æ—¥æœŸ</text>
            <picker mode="date" value="{{checkInDate}}" start="{{minDate}}" bindchange="onCheckInDateChange">
              <view class="date-picker">
                <text class="date-text">{{checkInDate || 'è¯·é€‰æ‹©'}}</text>
                <text class="date-arrow">â€º</text>
              </view>
            </picker>
          </view>
          <view class="date-item">
            <text class="date-label">é€€æˆ¿æ—¥æœŸ</text>
            <picker mode="date" value="{{checkOutDate}}" start="{{checkInDate || minDate}}" bindchange="onCheckOutDateChange">
              <view class="date-picker">
                <text class="date-text">{{checkOutDate || 'è¯·é€‰æ‹©'}}</text>
                <text class="date-arrow">â€º</text>
              </view>
            </picker>
          </view>
        </view>

        <!-- æˆ¿å‹åˆ—è¡¨ -->
        <view wx:if="{{detail.rooms && detail.rooms.length}}" class="room-modal-rooms">
          <view
            wx:for="{{detail.rooms}}"
            wx:key="id"
            class="room-modal-item {{selectedRoom && selectedRoom.id === item.id ? 'active' : ''}}"
            data-room="{{item}}"
            bindtap="onSelectRoom"
          >
            <view class="room-modal-item-info">
              <text class="room-modal-item-name">{{item.name}}</text>
              <text class="room-modal-item-desc">{{item.description}}</text>
            </view>
            <view class="room-modal-item-price">
              <text class="room-modal-item-price-text">Â¥{{item.price}}</text>
              <text class="room-modal-item-price-unit">/æ™š</text>
            </view>
            <view wx:if="{{selectedRoom && selectedRoom.id === item.id}}" class="room-modal-item-check">âœ“</view>
          </view>
        </view>
      </scroll-view>

        <!-- æ•°é‡é€‰æ‹© -->
        <view class="room-modal-footer">
          <view class="quantity-selector">
            <text class="quantity-label">æ•°é‡ï¼š</text>
            <view class="quantity-controls">
              <view class="quantity-btn minus" bindtap="onDecreaseQuantity">-</view>
              <text class="quantity-value">{{quantity}}</text>
              <view class="quantity-btn plus" bindtap="onIncreaseQuantity">+</view>
            </view>
          </view>
        <view class="room-modal-actions">
          <view class="room-modal-btn cancel" bindtap="onCloseRoomModal">å–æ¶ˆ</view>
          <view class="room-modal-btn confirm" bindtap="onBookNow">ç¡®å®š</view>
        </view>
      </view>
    </view>
  </view>

  <!-- è§„æ ¼é€‰æ‹©å¼¹çª—ï¼ˆå•†å“ï¼‰ -->
  <view wx:if="{{showSpecModal && type === 'product'}}" class="spec-modal-mask" bindtap="onCloseSpecModal">
    <view class="spec-modal" catchtap="true">
      <view class="spec-modal-header">
        <text class="spec-modal-title">é€‰æ‹©è§„æ ¼</text>
        <text class="spec-modal-close" bindtap="onCloseSpecModal">âœ•</text>
      </view>
      
      <scroll-view class="spec-modal-content" scroll-y="true">
        <!-- å•†å“ä¿¡æ¯ -->
        <view class="spec-product-info">
          <image wx:if="{{detail.images && detail.images.length > 0}}" class="spec-product-image" src="{{detail.images[0]}}" mode="aspectFill" />
          <view class="spec-product-details">
            <text class="spec-product-name">{{detail.name}}</text>
            <text class="spec-product-price">Â¥{{detail.price}}</text>
          </view>
        </view>
        
        <!-- è§„æ ¼é€‰æ‹© -->
        <view wx:if="{{detail.specList && detail.specList.length > 0}}" class="spec-list">
          <view wx:for="{{detail.specList}}" wx:for-item="specItem" wx:key="key" class="spec-group">
            <view class="spec-group-title">{{specItem.key}}</view>
            <view class="spec-options">
              <!-- éå†è§„æ ¼é€‰é¡¹ -->
              <view
                wx:for="{{specItem.value}}" wx:for-item="option"
                wx:key="*this"
                class="spec-option {{selectedSpec[specItem.key] === option ? 'active' : ''}}"
                data-spec-key="{{specItem.key}}"
                data-spec-value="{{option}}"
                bindtap="onSelectSpec"
              >
                <text class="spec-option-text">{{option}}</text>
              </view>
            </view>
          </view>
        </view>
      </scroll-view>

      <!-- è§„æ ¼é€‰æ‹©æç¤ºä¿¡æ¯ -->
      <view wx:if="{{showSpecTip}}" class="spec-tip">
        <text class="spec-tip-text">{{specTipText}}</text>
      </view>

      <!-- æ•°é‡é€‰æ‹©å’Œæ“ä½œæŒ‰é’® -->
      <view class="spec-modal-footer">
        <view class="quantity-selector">
          <text class="quantity-label">æ•°é‡ï¼š</text>
          <view class="quantity-controls">
            <view class="quantity-btn minus" bindtap="onDecreaseQuantity">-</view>
            <text class="quantity-value">{{quantity}}</text>
            <view class="quantity-btn plus" bindtap="onIncreaseQuantity">+</view>
          </view>
        </view>
        <view class="spec-modal-actions">
          <view class="spec-modal-btn cancel" bindtap="onCloseSpecModal">å–æ¶ˆ</view>
          <view class="spec-modal-btn confirm" bindtap="onAddToCart">ç¡®å®š</view>
        </view>
      </view>
    </view>
  </view>
</view>
