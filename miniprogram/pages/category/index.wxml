<!--ÂàÜÁ±ªÈ°µ-->
<view class="page-container">
  <!-- Ëá™ÂÆö‰πâÂØºËà™Ê†è -->
  <custom-nav-bar title="ÂïÜÂìÅÂàÜÁ±ª" id="navBar" />

  <!-- ÂÜÖÂÆπÂå∫Âüü -->
  <view class="page-content" style="padding-top: {{navBarTotalHeight}}px;">
    <!-- Â∑¶Âè≥ÂàÜÊ†èÂ∏ÉÂ±Ä -->
    <view class="category-layout">
    <!-- Â∑¶‰æßÂàÜÁ±ªÂàóË°®ÔºàÊµèËßàÊ®°ÂºèÊó∂ÈöêËóèÔºâ -->
    <scroll-view wx:if="{{showCategorySidebar}}" class="category-sidebar" scroll-y="true">
      <view 
        wx:for="{{categories}}" 
        wx:key="id"
        class="category-item {{currentCategoryId === item.id ? 'active' : ''}}"
        data-categoryid="{{item.id}}"
        bindtap="onCategoryTap"
      >
        <text class="category-text">{{item.name}}</text>
      </view>
    </scroll-view>

    <!-- Âè≥‰æßÂïÜÂìÅÂàóË°® -->
    <scroll-view 
      class="product-content"
      scroll-y="true"
      refresher-enabled="true"
      refresher-triggered="{{loading && page === 1}}"
      bindrefresherrefresh="onPullDownRefresh"
      bindscrolltolower="onReachBottom"
    >
      <!-- È™®Êû∂Â±èÔºöÈ¶ñÊ¨°Âä†ËΩΩÊó∂ÊòæÁ§∫ -->
      <skeleton wx:if="{{loading && page === 1 && products.length === 0}}" type="product-list" loading="{{true}}" rows="{{5}}" animated="{{true}}" />

      <!-- ÂïÜÂìÅÂàóË°® -->
      <view class="product-list" wx:if="{{!loading || products.length > 0 || page > 1}}">
        <view 
          wx:for="{{products}}"
          wx:key="id"
          class="product-item"
          bindtap="onProductTap"
          data-product="{{item}}"
        >
          <!-- ÂïÜÂìÅÂõæÁâá -->
          <view class="product-image-wrapper">
            <image
              class="product-image"
              src="{{item.image || item.coverImage || '/static/images/default-product.png'}}"
              mode="aspectFill"
              lazy-load="{{true}}"
            />
          </view>
          
          <!-- ÂïÜÂìÅ‰ø°ÊÅØ -->
          <view class="product-info">
            <view class="product-title">{{item.name}}</view>
            
            <!-- CONFIGÁ±ªÂûãÔºöÂè™ÊòæÁ§∫ÂïÜÂìÅÂêçÁß∞ÂíåÊèèËø∞Ôºå‰∏çÊòæÁ§∫‰ª∑Ê†º„ÄÅÈîÄÈáèÁ≠â -->
            <view wx:if="{{currentCategoryType === 'CONFIG'}}">
              <view wx:if="{{item.description}}" class="product-description">
                {{item.description}}
              </view>
            </view>
            
            <!-- H5Á±ªÂûãÔºöÊòæÁ§∫ÊèèËø∞ÂíåÈ¢ÑÁ∫¶ÊåâÈíÆ -->
            <view wx:elif="{{currentCategoryType === 'H5'}}">
              <view wx:if="{{item.description}}" class="product-description">
                <!-- H5Á±ªÂûãÔºö‰ΩøÁî®rich-textÂ±ïÁ§∫ÂØåÊñáÊú¨ -->
                <rich-text nodes="{{item.description}}" type="html" class="description-content-rich"></rich-text>
              </view>
              <view wx:if="{{item.h5Link}}" class="product-reserve-btn">
                <button 
                  class="reserve-button" 
                  size="mini" 
                  type="primary"
                  data-h5-link="{{item.h5Link}}"
                  catchtap="onReserveTap"
                >
                  È¢ÑÁ∫¶
                </button>
              </view>
            </view>
            
            <!-- DISPLAYÁ±ªÂûãÊàñÂÖ∂‰ªñÔºöÊòæÁ§∫‰ª∑Ê†º„ÄÅÈîÄÈáèÁ≠âÂÆåÊï¥‰ø°ÊÅØ -->
            <view wx:else>
              <view class="product-sales">Â∑≤ÂîÆ{{item.sales || 0}}‰ª∂</view>
              <view class="product-price-wrapper">
                <view class="product-price">
                  <text class="price-symbol">¬•</text>
                  <text class="price-value">{{item.price || item.minPrice || 0}}</text>
                </view>
                <text wx:if="{{item.originalPrice && item.originalPrice > (item.price || item.minPrice || 0)}}" class="price-original">
                  ¬•{{item.originalPrice}}
                </text>
              </view>
            </view>
          </view>
          
          <!-- Ë¥≠Áâ©ËΩ¶ÂõæÊ†áÔºàÊµèËßàÊ®°ÂºèÊó∂ÈöêËóèÔºå‰∏îÈùûCONFIGÂíåH5Á±ªÂûãÊó∂ÊòæÁ§∫Ôºâ -->
          <view wx:if="{{!isBrowseMode && currentCategoryType !== 'CONFIG' && currentCategoryType !== 'H5'}}" class="product-cart-icon" catchtap="onAddToCart" data-product="{{item}}">
            <text class="cart-icon">üõí</text>
          </view>
        </view>
      </view>
      
      <!-- Âä†ËΩΩÊõ¥Â§öÊèêÁ§∫ -->
      <view wx:if="{{loading && page > 1}}" class="loading-more">
        <text class="loading-more-text">Âä†ËΩΩ‰∏≠...</text>
      </view>
      
      <!-- Ê≤°ÊúâÊõ¥Â§öÊèêÁ§∫ -->
      <view wx:if="{{!hasMore && products.length > 0}}" class="no-more">
        <text class="no-more-text">‰∫≤,Â∑≤ÁªèÂà∞Â∫ïÂï¶!</text>
      </view>
      
      <!-- Á©∫Áä∂ÊÄÅ -->
      <view wx:if="{{!loading && products.length === 0}}" class="empty-container">
        <text class="empty-text">ÊöÇÊó†ÂïÜÂìÅ</text>
      </view>
    </scroll-view>
  </view>

  <!-- ËßÑÊ†ºÈÄâÊã©ÂºπÁ™óÔºàÂïÜÂìÅÔºâ -->
  <view wx:if="{{showSpecModal}}" class="spec-modal-mask" bindtap="onCloseSpecModal">
    <view class="spec-modal" catchtap="true">
      <view class="spec-modal-header">
        <text class="spec-modal-title">ÈÄâÊã©ËßÑÊ†º</text>
        <text class="spec-modal-close" bindtap="onCloseSpecModal">‚úï</text>
      </view>
      
      <scroll-view class="spec-modal-content" scroll-y="true">
        <!-- ÂïÜÂìÅ‰ø°ÊÅØ -->
        <view class="spec-product-info">
          <image wx:if="{{currentProductDetail && currentProductDetail.images && currentProductDetail.images.length > 0}}" class="spec-product-image" src="{{currentProductDetail.images[0]}}" mode="aspectFill" />
          <image wx:elif="{{currentProductDetail && (currentProductDetail.image || currentProductDetail.coverImage)}}" class="spec-product-image" src="{{currentProductDetail.image || currentProductDetail.coverImage}}" mode="aspectFill" />
          <view class="spec-product-details">
            <text class="spec-product-name">{{currentProductDetail ? currentProductDetail.name : ''}}</text>
            <text class="spec-product-price">¬•{{currentProductDetail ? (currentProductDetail.price || currentProductDetail.minPrice || 0) : 0}}</text>
          </view>
        </view>
        
        <!-- ËßÑÊ†ºÈÄâÊã© -->
        <view wx:if="{{currentProductDetail && currentProductDetail.specList && currentProductDetail.specList.length > 0}}" class="spec-list">
          <view wx:for="{{currentProductDetail.specList}}" wx:for-item="specItem" wx:key="key" class="spec-group">
            <view class="spec-group-title">{{specItem.key}}</view>
            <view class="spec-options">
              <!-- ÈÅçÂéÜËßÑÊ†ºÈÄâÈ°π -->
              <view
                wx:for="{{specItem.value}}" wx:for-item="option"
                wx:key="*this"
                class="spec-option {{selectedSpec[specItem.key] === option ? 'active' : ''}}"
                data-spec-key="{{specItem.key}}"
                data-spec-value="{{option}}"
                bindtap="onSelectSpec"
              >
                <text class="spec-option-text">{{option}}</text>
              </view>
            </view>
          </view>
        </view>
      </scroll-view>

      <!-- ËßÑÊ†ºÈÄâÊã©ÊèêÁ§∫‰ø°ÊÅØ -->
      <view wx:if="{{showSpecTip}}" class="spec-tip">
        <text class="spec-tip-text">{{specTipText}}</text>
      </view>

      <!-- Êï∞ÈáèÈÄâÊã©ÂíåÊìç‰ΩúÊåâÈíÆ -->
      <view class="spec-modal-footer">
        <view class="quantity-selector">
          <text class="quantity-label">Êï∞ÈáèÔºö</text>
          <view class="quantity-controls">
            <view class="quantity-btn minus" bindtap="onDecreaseQuantity">-</view>
            <text class="quantity-value">{{quantity}}</text>
            <view class="quantity-btn plus" bindtap="onIncreaseQuantity">+</view>
          </view>
        </view>
        <view class="spec-modal-actions">
          <view class="spec-modal-btn cancel" bindtap="onCloseSpecModal">ÂèñÊ∂à</view>
          <view class="spec-modal-btn confirm" bindtap="onAddToCart">Á°ÆÂÆö</view>
        </view>
      </view>
    </view>
  </view>
  <!-- È°µÈù¢ÂÜÖÂÆπÂå∫ÂüüÁªìÊùü -->
  </view>
</view>
